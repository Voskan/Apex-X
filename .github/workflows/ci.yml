name: CI

on:
  push:
  pull_request:

jobs:
  lint-type-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple -e ".[dev]"
      - name: Lint
        run: |
          ruff check .
          black --check .
      - name: Typecheck
        run: mypy
      - name: Test
        run: pytest

  docs-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install docs deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"
      - name: Build docs
        run: mkdocs build --strict

  perf-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple -e ".[dev]"
      - name: Run perf regression compare (CPU)
        run: |
          python scripts/perf_regression.py \
            --compare \
            --baseline scripts/perf_baseline_cpu.json \
            --output artifacts/perf_current_ci.json \
            --summary artifacts/perf_compare_ci.json \
            --infer-iters 15 \
            --micro-iters 25 \
            --infer-warmup 3 \
            --micro-warmup 3
      - name: Upload perf artifacts
        uses: actions/upload-artifact@v4
        with:
          name: perf-regression-artifacts
          path: |
            artifacts/perf_current_ci.json
            artifacts/perf_compare_ci.json

  go-runtime:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - name: Go runtime tests
        run: |
          cd runtime/go
          go test ./...
