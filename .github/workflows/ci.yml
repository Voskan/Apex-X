name: CI

on:
  push:
  pull_request:

jobs:
  lint-type-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple -e ".[dev]"
      - name: Lint
        run: |
          ruff check .
          black --check .
      - name: Typecheck
        run: mypy --no-incremental --cache-dir=/dev/null
      - name: Test
        run: pytest

  docs-build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install docs deps
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"
      - name: Build docs
        run: mkdocs build --strict

  perf-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple -e ".[dev]"
      - name: Run perf regression compare (CPU)
        run: |
          python scripts/perf_regression.py \
            --compare \
            --baseline scripts/perf_baseline_cpu.json \
            --output artifacts/perf_current_ci.json \
            --summary artifacts/perf_compare_ci.json \
            --trend-output artifacts/perf_trend_cpu_ci.json \
            --infer-iters 15 \
            --micro-iters 25 \
            --infer-warmup 3 \
            --micro-warmup 3
      - name: Capture runtime capability snapshot (CPU CI)
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          from apex_x.runtime import detect_runtime_caps

          payload = detect_runtime_caps().to_dict()
          output = Path("artifacts/runtime/caps_ci.json")
          output.parent.mkdir(parents=True, exist_ok=True)
          output.write_text(json.dumps(payload, indent=2, sort_keys=True) + "\n", encoding="utf-8")
          print(f"runtime_caps output={output}")
          PY
      - name: Generate release evidence draft (CPU CI)
        run: |
          python scripts/release_attestation.py \
            --runtime-target cpu \
            --artifact-path performance_report=artifacts/perf_compare_ci.json \
            --artifact-path runtime_capability_snapshot=artifacts/runtime/caps_ci.json \
            --gate-status lint_type_tests=PENDING \
            --gate-status cpu_perf_regression=PASS \
            --gate-status gpu_perf_regression=N/A \
            --gate-status runtime_backend_parity=PENDING \
            --gate-status runtime_capability_transparency=PASS \
            --gate-status security_review=PENDING \
            --gate-status documentation_sync=PENDING \
            --output-json artifacts/release/release_attestation_ci.json \
            --output-md artifacts/release/release_attestation_ci.md
      - name: Upload perf artifacts
        uses: actions/upload-artifact@v4
        with:
          name: perf-regression-artifacts
          path: |
            artifacts/perf_current_ci.json
            artifacts/perf_compare_ci.json
            artifacts/perf_trend_cpu_ci.json
            artifacts/runtime/caps_ci.json
            artifacts/release/release_attestation_ci.json
            artifacts/release/release_attestation_ci.md

  go-runtime:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - name: Go runtime canary SLA gate
        env:
          APEXX_GO_CANARY_GATE_REQUESTS: "96"
          APEXX_GO_CANARY_GATE_CONCURRENCY: "12"
          APEXX_GO_CANARY_GATE_PRIMARY_DELAY_MS: "3"
          APEXX_GO_CANARY_GATE_CANARY_DELAY_MS: "3"
          APEXX_GO_CANARY_GATE_MAX_OVERHEAD_RATIO: "0.75"
          APEXX_GO_CANARY_GATE_MAX_OVERHEAD_ABS_MS: "5.0"
          APEXX_GO_CANARY_GATE_MAX_TIMEOUT_RATE: "0.00"
          APEXX_GO_CANARY_GATE_MAX_QUEUE_OVERFLOW_RATE: "0.00"
        run: |
          cd runtime/go
          go test ./internal/service -run TestCanaryLoadGateThresholds -count=1 -v
      - name: Go runtime tests
        run: |
          cd runtime/go
          go test ./...
